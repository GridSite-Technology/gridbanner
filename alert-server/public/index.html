<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GridBanner Alert Server - Admin</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1a1a1a;
            margin-bottom: 8px;
            font-size: 28px;
            font-weight: 700;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 15px;
        }
        .form-group {
            margin-bottom: 24px;
        }
        .form-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
        }
        .form-section h3 {
            color: #495057;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid #dee2e6;
        }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: #333;
        }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        textarea {
            min-height: 120px;
            resize: vertical;
        }
        .color-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .color-preview {
            width: 40px;
            height: 40px;
            border: 2px solid #ddd;
            border-radius: 4px;
            margin-top: 8px;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-primary:hover { background: #0056b3; }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-danger:hover { background: #c82333; }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-secondary:hover { background: #5a6268; }
        .status {
            margin-top: 20px;
            padding: 12px;
            border-radius: 4px;
            display: none;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .current-alert {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
            color: white;
        }
        .current-alert h3 {
            margin-bottom: 12px;
            color: white;
            font-size: 18px;
            font-weight: 600;
        }
        .current-alert pre {
            background: rgba(255, 255, 255, 0.95);
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
            color: #333;
            margin: 0;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .tabs {
            display: flex;
            border-bottom: 2px solid #dee2e6;
            margin-bottom: 20px;
        }
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }
        .tab:hover {
            color: #007bff;
        }
        .tab.active {
            color: #007bff;
            border-bottom-color: #007bff;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        table th, table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        table tr:hover {
            background: #f8f9fa;
        }
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .list-item-actions {
            display: flex;
            gap: 10px;
        }
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }
        @media (max-width: 768px) {
            .grid, .color-group { grid-template-columns: 1fr; }
            .tabs { flex-wrap: wrap; }
            table { font-size: 12px; }
        }
    </style>
</head>
<body>
    <!-- Authentication Screen -->
    <div id="authScreen" style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: #f5f5f5;">
        <div style="background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-width: 400px; width: 90%;">
            <h1 style="margin-bottom: 10px; text-align: center;">GridBanner Alert Server</h1>
            <p style="text-align: center; color: #666; margin-bottom: 30px;">Admin authentication required</p>
            <div class="form-group">
                <label for="authKey">Admin Key *</label>
                <input type="password" id="authKey" placeholder="Enter admin key" style="margin-bottom: 15px;" autofocus>
                <button type="button" class="btn-primary" id="authBtn" style="width: 100%;">Authenticate</button>
            </div>
            <div class="status" id="authStatus" style="margin-top: 15px;"></div>
        </div>
    </div>

    <!-- Main Content (hidden until authenticated) -->
    <div id="mainContent" style="display: none;">
    <div class="container">
        <h1>GridBanner Alert Server</h1>
        <p class="subtitle">Centralized alert management for GridBanner workstations</p>

        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab active" data-tab="alerts">Alerts</button>
            <button class="tab" data-tab="templates">Templates</button>
            <button class="tab" data-tab="sites">Sites</button>
            <button class="tab" data-tab="systems">Systems</button>
            <button class="tab" data-tab="settings">Settings</button>
        </div>

        <!-- Alerts Tab -->
        <div id="tab-alerts" class="tab-content active">
        <div class="current-alert" id="currentAlert">
            <h3>Current Alert</h3>
            <pre id="currentAlertContent">Loading...</pre>
        </div>

        <form id="alertForm">
            <div class="form-group">
                <label>Send From</label>
                <select id="alertSource" style="margin-bottom: 10px;">
                    <option value="manual">One-Time Alert (Manual Entry)</option>
                    <option value="template">Template</option>
                </select>
                <select id="templateSelect" style="display: none; margin-bottom: 10px;">
                    <option value="">Select a template...</option>
                </select>
            </div>

            <div class="form-group">
                <label>Target Sites</label>
                <div style="margin-bottom: 10px;">
                    <label style="font-weight: normal;">
                        <input type="radio" name="siteTarget" value="all" checked> All Sites
                    </label>
                    <label style="font-weight: normal; margin-left: 20px;">
                        <input type="radio" name="siteTarget" value="selected"> Selected Sites
                    </label>
                </div>
                <div id="siteCheckboxes" style="display: none; max-height: 150px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px;">
                    <!-- Sites will be populated here -->
                </div>
            </div>

            <div class="form-group">
                <label for="level">Alert Level *</label>
                <select id="level" required>
                    <option value="routine">Routine</option>
                    <option value="urgent">Urgent</option>
                    <option value="critical">Critical</option>
                    <option value="super_critical">Super Critical</option>
                </select>
            </div>

            <div class="form-group">
                <label for="audioFile">Alert Sound</label>
                <select id="audioFile">
                    <option value="">Default System Beep</option>
                </select>
                <div style="font-size: 12px; color: #666; margin-top: 4px;">Choose a custom audio file or use the default system beep</div>
            </div>

            <div class="form-group">
                <label for="summary">Summary *</label>
                <input type="text" id="summary" required placeholder="Brief alert summary">
            </div>

            <div class="form-group">
                <label for="message">Message *</label>
                <textarea id="message" required placeholder="Full alert message text"></textarea>
            </div>

            <div class="color-group">
                <div class="form-group">
                    <label for="background_color">Background Color *</label>
                    <input type="text" id="background_color" required value="#B00020" placeholder="#FF0000">
                    <div class="color-preview" id="bgPreview" style="background: #B00020;"></div>
                </div>
                <div class="form-group">
                    <label for="foreground_color">Foreground Color *</label>
                    <input type="text" id="foreground_color" required value="#FFFFFF" placeholder="#FFFFFF">
                    <div class="color-preview" id="fgPreview" style="background: #FFFFFF;"></div>
                </div>
            </div>

            <div class="grid">
                <div class="form-group">
                    <label for="contact_name">Contact Name</label>
                    <input type="text" id="contact_name" placeholder="Optional">
                </div>
                <div class="form-group">
                    <label for="contact_phone">Contact Phone</label>
                    <input type="text" id="contact_phone" placeholder="Optional">
                </div>
                <div class="form-group">
                    <label for="contact_email">Contact Email</label>
                    <input type="email" id="contact_email" placeholder="Optional">
                </div>
                <div class="form-group">
                    <label for="contact_teams">Contact Teams</label>
                    <input type="text" id="contact_teams" placeholder="Optional (msteams: or https://)">
                </div>
            </div>

            <div class="button-group">
                <button type="submit" class="btn-primary">Send Alert</button>
                <button type="button" class="btn-danger" id="clearBtn">Clear Alert</button>
                <button type="button" class="btn-secondary" id="refreshBtn">Refresh</button>
            </div>
        </form>

        <div class="status" id="status"></div>
        </div>

        <!-- Templates Tab -->
        <div id="tab-templates" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Templates</h2>
                <button type="button" class="btn-primary" id="newTemplateBtn">New Template</button>
            </div>
            <div id="templatesList"></div>
        </div>

        <!-- Sites Tab -->
        <div id="tab-sites" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <div>
                    <h2 style="margin-bottom: 4px;">Sites</h2>
                    <p style="color: #666; font-size: 14px; margin: 0;">Manage site locations for targeted alert distribution</p>
                </div>
                <button type="button" class="btn-primary" id="newSiteBtn">+ New Site</button>
            </div>
            <div id="sitesList" style="min-height: 200px;"></div>
        </div>

        <!-- Systems Tab -->
        <div id="tab-systems" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div>
                    <h2 style="margin-bottom: 4px;">Systems</h2>
                    <p style="color: #666; font-size: 14px; margin: 0;">Monitor all GridBanner workstations</p>
                </div>
                <button type="button" class="btn-secondary" id="refreshSystemsBtn">Refresh</button>
            </div>

            <!-- Filters -->
            <div class="form-section" style="margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; align-items: end;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="filterWorkstation" style="font-size: 12px; font-weight: 600;">Filter Workstation</label>
                        <input type="text" id="filterWorkstation" placeholder="Search..." style="font-size: 13px;">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="filterCompany" style="font-size: 12px; font-weight: 600;">Filter Company</label>
                        <input type="text" id="filterCompany" placeholder="Search..." style="font-size: 13px;">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="filterSite" style="font-size: 12px; font-weight: 600;">Filter Site</label>
                        <input type="text" id="filterSite" placeholder="Search..." style="font-size: 13px;">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="filterCompliance" style="font-size: 12px; font-weight: 600;">Compliance</label>
                        <select id="filterCompliance" style="font-size: 13px;">
                            <option value="">All</option>
                            <option value="1">Compliant</option>
                            <option value="0">Not Compliant</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 10px;">
                    <button type="button" class="btn-secondary btn-small" id="clearFiltersBtn">Clear Filters</button>
                </div>
            </div>

            <!-- Table -->
            <div style="overflow-x: auto; background: white; border-radius: 8px; border: 1px solid #e0e0e0;">
                <table id="systemsTable" style="margin: 0;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="cursor: pointer; user-select: none;" data-sort="workstation_name">
                                Workstation <span class="sort-indicator"></span>
                            </th>
                            <th style="cursor: pointer; user-select: none;" data-sort="username">
                                Username <span class="sort-indicator"></span>
                            </th>
                            <th style="cursor: pointer; user-select: none;" data-sort="company">
                                Company <span class="sort-indicator"></span>
                            </th>
                            <th style="cursor: pointer; user-select: none;" data-sort="classification">
                                Classification <span class="sort-indicator"></span>
                            </th>
                            <th style="cursor: pointer; user-select: none;" data-sort="location">
                                Location <span class="sort-indicator"></span>
                            </th>
                            <th style="cursor: pointer; user-select: none;" data-sort="compliance_status">
                                Compliance <span class="sort-indicator"></span>
                            </th>
                            <th style="cursor: pointer; user-select: none;" data-sort="last_seen">
                                Last Seen <span class="sort-indicator"></span>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="systemsTableBody">
                        <tr><td colspan="7" style="text-align: center; padding: 40px; color: #666;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div id="systemsPagination" style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <div style="color: #666; font-size: 14px;">
                    Showing <span id="systemsShowing">0</span> of <span id="systemsTotal">0</span> systems
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button type="button" class="btn-secondary btn-small" id="systemsPrevBtn" disabled>Previous</button>
                    <span id="systemsPageInfo" style="font-size: 14px; color: #333;">Page 1</span>
                    <button type="button" class="btn-secondary btn-small" id="systemsNextBtn" disabled>Next</button>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <label style="font-size: 14px; color: #666;">Per page:</label>
                    <select id="systemsPerPage" style="font-size: 13px; padding: 4px 8px;">
                        <option value="10">10</option>
                        <option value="25" selected>25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Audio Tab -->
        <div id="tab-audio" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <div>
                    <h2 style="margin-bottom: 4px;">Audio Files</h2>
                    <p style="color: #666; font-size: 14px; margin: 0;">Manage custom audio files for alert notifications</p>
                </div>
                <button type="button" class="btn-primary" id="uploadAudioBtn">+ Upload Audio</button>
            </div>

            <input type="file" id="audioFileInput" accept="audio/*" style="display: none;">
            
            <div id="audioList" style="min-height: 200px;"></div>
        </div>

        <!-- Settings Tab -->
        <div id="tab-settings" class="tab-content">
            <h2>Settings</h2>
            
            <div class="form-section">
                <h3>Admin Key</h3>
                <div class="form-group">
                    <button type="button" class="btn-secondary" id="changeKeyBtnSettings">Change Admin Key</button>
                </div>
            </div>

            <div class="form-section">
                <h3>Default Contact Information</h3>
                <p style="color: #666; margin-bottom: 16px; font-size: 14px;">These values will be pre-filled when creating new alerts or templates.</p>
                <div class="grid">
                    <div class="form-group">
                        <label for="default_contact_name">Default Contact Name</label>
                        <input type="text" id="default_contact_name" placeholder="Optional">
                    </div>
                    <div class="form-group">
                        <label for="default_contact_phone">Default Contact Phone</label>
                        <input type="text" id="default_contact_phone" placeholder="Optional">
                    </div>
                    <div class="form-group">
                        <label for="default_contact_email">Default Contact Email</label>
                        <input type="email" id="default_contact_email" placeholder="Optional">
                    </div>
                    <div class="form-group">
                        <label for="default_contact_teams">Default Contact Teams</label>
                        <input type="text" id="default_contact_teams" placeholder="Optional">
                    </div>
                </div>
                <div class="button-group" style="margin-top: 20px;">
                    <button type="button" class="btn-primary" id="saveDefaultsBtn">Save Defaults</button>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Change Admin Key Modal -->
    <div id="keyModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 8px; max-width: 400px; width: 90%; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
            <h2 style="margin-bottom: 20px;">Change Admin Key</h2>
            <div class="form-group">
                <label for="newKey">New Admin Key *</label>
                <input type="password" id="newKey" required placeholder="Enter new admin key (min 4 characters)" style="margin-bottom: 10px;">
                <input type="password" id="confirmKey" required placeholder="Confirm new admin key" style="margin-bottom: 10px;">
                <div style="font-size: 12px; color: #666;">The admin key must be at least 4 characters long.</div>
            </div>
            <div class="button-group" style="margin-top: 20px;">
                <button type="button" class="btn-primary" id="saveKeyBtn">Save</button>
                <button type="button" class="btn-secondary" id="cancelKeyBtn">Cancel</button>
            </div>
            <div class="status" id="keyStatus" style="margin-top: 15px;"></div>
        </div>
    </div>

    <!-- Template Editor Modal -->
    <div id="templateModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;">
        <div style="background: white; padding: 30px; border-radius: 8px; max-width: 800px; width: 90%; box-shadow: 0 4px 12px rgba(0,0,0,0.2); margin: 20px auto;">
            <h2 style="margin-bottom: 20px;" id="templateModalTitle">Create Template</h2>
            <form id="templateForm">
                <div class="form-group">
                    <label for="templateName">Template Name *</label>
                    <input type="text" id="templateName" required placeholder="Enter template name">
                </div>

                <div class="form-group">
                    <label for="templateLevel">Alert Level *</label>
                    <select id="templateLevel" required>
                        <option value="routine">Routine</option>
                        <option value="urgent">Urgent</option>
                        <option value="critical">Critical</option>
                        <option value="super_critical">Super Critical</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="templateSummary">Summary *</label>
                    <input type="text" id="templateSummary" required placeholder="Brief alert summary">
                </div>

                <div class="form-group">
                    <label for="templateMessage">Message *</label>
                    <textarea id="templateMessage" required placeholder="Full alert message text" style="min-height: 120px;"></textarea>
                </div>

                <div class="color-group">
                    <div class="form-group">
                        <label for="templateBgColor">Background Color *</label>
                        <input type="text" id="templateBgColor" required value="#B00020" placeholder="#FF0000">
                        <div class="color-preview" id="templateBgPreview" style="background: #B00020;"></div>
                    </div>
                    <div class="form-group">
                        <label for="templateFgColor">Foreground Color *</label>
                        <input type="text" id="templateFgColor" required value="#FFFFFF" placeholder="#FFFFFF">
                        <div class="color-preview" id="templateFgPreview" style="background: #FFFFFF;"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="templateSite">Site (optional)</label>
                    <select id="templateSite">
                        <option value="">All Sites</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="templateAudioFile">Alert Sound</label>
                    <select id="templateAudioFile">
                        <option value="">Default System Beep</option>
                    </select>
                    <div style="font-size: 12px; color: #666; margin-top: 4px;">Choose a custom audio file or use the default system beep</div>
                </div>

                <div class="grid">
                    <div class="form-group">
                        <label for="templateContactName">Contact Name</label>
                        <input type="text" id="templateContactName" placeholder="Optional">
                    </div>
                    <div class="form-group">
                        <label for="templateContactPhone">Contact Phone</label>
                        <input type="text" id="templateContactPhone" placeholder="Optional">
                    </div>
                    <div class="form-group">
                        <label for="templateContactEmail">Contact Email</label>
                        <input type="email" id="templateContactEmail" placeholder="Optional">
                    </div>
                    <div class="form-group">
                        <label for="templateContactTeams">Contact Teams</label>
                        <input type="text" id="templateContactTeams" placeholder="Optional">
                    </div>
                </div>

                <div class="button-group" style="margin-top: 25px;">
                    <button type="submit" class="btn-primary" id="saveTemplateModalBtn">Save Template</button>
                    <button type="button" class="btn-secondary" id="cancelTemplateBtn">Cancel</button>
                </div>
            </form>
            <div class="status" id="templateStatus" style="margin-top: 15px;"></div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let ADMIN_KEY = null;
        let headers = { 'Content-Type': 'application/json' };

        // Authentication functions
        function showAuthError(message) {
            const authStatus = document.getElementById('authStatus');
            authStatus.textContent = message;
            authStatus.className = 'status error';
            authStatus.style.display = 'block';
        }

        function clearAuthError() {
            const authStatus = document.getElementById('authStatus');
            authStatus.style.display = 'none';
        }

        async function validateAdminKey(key) {
            if (!key || key.trim().length === 0) {
                return { valid: false, error: 'Admin key cannot be empty' };
            }

            try {
                const res = await fetch(`${API_BASE}/admin/key`, {
                    method: 'GET',
                    headers: { 'X-Admin-Key': key.trim() }
                });

                if (res.ok) {
                    return { valid: true };
                } else {
                    // Check if response is JSON
                    const contentType = res.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const err = await res.json();
                        return { valid: false, error: err.error || 'Invalid admin key' };
                    } else {
                        // Response is not JSON (probably HTML error page)
                        const text = await res.text();
                        if (res.status === 401) {
                            return { valid: false, error: 'Invalid admin key' };
                        } else if (res.status === 404) {
                            return { valid: false, error: 'API endpoint not found. Please ensure the server is running and up to date.' };
                        } else {
                            return { valid: false, error: `Server error (${res.status}). Please check the server logs.` };
                        }
                    }
                }
            } catch (err) {
                return { valid: false, error: 'Failed to connect to server: ' + err.message };
            }
        }

        function showMainContent() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            // Load initial data
            loadSites(); // Load sites for checkboxes
            loadSettings(); // Load default settings
            // Attach event listeners now that elements are visible
            attachEventListeners();
        }

        function attachEventListeners() {
            // Only attach if not already attached
            if (window.listenersAttached) return;
            window.listenersAttached = true;

            // Color preview updates
            const bgColor = document.getElementById('background_color');
            const fgColor = document.getElementById('foreground_color');
            if (bgColor) {
                bgColor.addEventListener('input', (e) => {
                    document.getElementById('bgPreview').style.background = e.target.value;
                });
            }
            if (fgColor) {
                fgColor.addEventListener('input', (e) => {
                    document.getElementById('fgPreview').style.background = e.target.value;
                });
            }

            // Form submit
            const alertForm = document.getElementById('alertForm');
            if (alertForm && !alertForm.dataset.listenerAttached) {
                alertForm.dataset.listenerAttached = 'true';
                alertForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const alert = {
                        level: document.getElementById('level').value,
                        summary: document.getElementById('summary').value,
                        message: document.getElementById('message').value,
                        background_color: document.getElementById('background_color').value,
                        foreground_color: document.getElementById('foreground_color').value
                    };

                    const audioFile = document.getElementById('audioFile').value.trim();
                    if (audioFile) alert.audio_file = audioFile;

                    const contactName = document.getElementById('contact_name').value.trim();
                    const contactPhone = document.getElementById('contact_phone').value.trim();
                    const contactEmail = document.getElementById('contact_email').value.trim();
                    const contactTeams = document.getElementById('contact_teams').value.trim();

                    if (contactName) alert.alert_contact_name = contactName;
                    if (contactPhone) alert.alert_contact_phone = contactPhone;
                    if (contactEmail) alert.alert_contact_email = contactEmail;
                    if (contactTeams) alert.alert_contact_teams = contactTeams;
                    
                    // Handle site selection
                    const siteTarget = document.querySelector('input[name="siteTarget"]:checked');
                    if (siteTarget && siteTarget.value === 'selected') {
                        const selectedSites = Array.from(document.querySelectorAll('input[name="selectedSites"]:checked'))
                            .map(cb => cb.value);
                        if (selectedSites.length > 0) {
                            alert.site = selectedSites[0];
                        }
                    }

                    try {
                        const res = await fetch(`${API_BASE}/alert`, {
                            method: 'POST',
                            headers,
                            body: JSON.stringify(alert)
                        });

                        if (res.ok) {
                            showStatus('Alert updated successfully');
                            await loadCurrentAlert();
                        } else if (res.status === 401) {
                            handleAuthError();
                        } else {
                            const err = await res.json();
                            showStatus('Error: ' + (err.error || 'Failed to update alert'), true);
                        }
                    } catch (err) {
                        showStatus('Error: ' + err.message, true);
                    }
                });
            }

            // Clear alert
            const clearBtn = document.getElementById('clearBtn');
            if (clearBtn && !clearBtn.dataset.listenerAttached) {
                clearBtn.dataset.listenerAttached = 'true';
                clearBtn.addEventListener('click', async () => {
                    if (!confirm('Clear the current alert?')) return;
                    try {
                        const res = await fetch(`${API_BASE}/alert`, {
                            method: 'DELETE',
                            headers
                        });

                        if (res.ok) {
                            showStatus('Alert cleared');
                            await loadCurrentAlert();
                            document.getElementById('alertForm').reset();
                        } else if (res.status === 401) {
                            handleAuthError();
                        } else {
                            const err = await res.json();
                            showStatus('Error: ' + (err.error || 'Failed to clear alert'), true);
                        }
                    } catch (err) {
                        showStatus('Error: ' + err.message, true);
                    }
                });
            }

            // Refresh
            const refreshBtn = document.getElementById('refreshBtn');
            if (refreshBtn && !refreshBtn.dataset.listenerAttached) {
                refreshBtn.dataset.listenerAttached = 'true';
                refreshBtn.addEventListener('click', async () => {
                    try {
                        const alert = await loadCurrentAlert();
                        if (alert !== null) {
                            populateForm(alert);
                        }
                    } catch (err) {
                        showStatus('Error refreshing: ' + err.message, true);
                    }
                });
            }

            // Save as template button
            const saveTemplateBtn = document.getElementById('saveTemplateBtn');
            if (saveTemplateBtn && !saveTemplateBtn.dataset.listenerAttached) {
                saveTemplateBtn.dataset.listenerAttached = 'true';
                saveTemplateBtn.addEventListener('click', async () => {
                    const name = prompt('Enter template name:');
                    if (!name || name.trim().length === 0) return;

                    const template = {
                        name: name.trim(),
                        level: document.getElementById('level').value,
                        summary: document.getElementById('summary').value,
                        message: document.getElementById('message').value,
                        background_color: document.getElementById('background_color').value,
                        foreground_color: document.getElementById('foreground_color').value
                    };

                    const audioFile = document.getElementById('audioFile').value.trim();
                    if (audioFile) template.audio_file = audioFile;

                    const contactName = document.getElementById('contact_name').value.trim();
                    const contactPhone = document.getElementById('contact_phone').value.trim();
                    const contactEmail = document.getElementById('contact_email').value.trim();
                    const contactTeams = document.getElementById('contact_teams').value.trim();

                    if (contactName) template.alert_contact_name = contactName;
                    if (contactPhone) template.alert_contact_phone = contactPhone;
                    if (contactEmail) template.alert_contact_email = contactEmail;
                    if (contactTeams) template.alert_contact_teams = contactTeams;

                    // Handle site selection
                    const siteTarget = document.querySelector('input[name="siteTarget"]:checked');
                    if (siteTarget && siteTarget.value === 'selected') {
                        const selectedSites = Array.from(document.querySelectorAll('input[name="selectedSites"]:checked'))
                            .map(cb => cb.value);
                        if (selectedSites.length > 0) {
                            template.site = selectedSites[0];
                        }
                    }

                    try {
                        const res = await fetch(`${API_BASE}/templates`, {
                            method: 'POST',
                            headers,
                            body: JSON.stringify(template)
                        });

                        if (res.ok) {
                            showStatus('Template saved successfully');
                            loadTemplates();
                        } else {
                            const err = await res.json();
                            showStatus('Error: ' + (err.error || 'Failed to save template'), true);
                        }
                    } catch (err) {
                        showStatus('Error: ' + err.message, true);
                    }
                });
            }

            // New template button - create template editor
            const newTemplateBtn = document.getElementById('newTemplateBtn');
            if (newTemplateBtn && !newTemplateBtn.dataset.listenerAttached) {
                newTemplateBtn.dataset.listenerAttached = 'true';
                newTemplateBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('New Template button clicked');
                    try {
                        openTemplateModal();
                    } catch (err) {
                        console.error('Error opening template modal:', err);
                        alert('Error opening template form: ' + err.message);
                    }
                });
            }

            // Template form handlers
            const templateForm = document.getElementById('templateForm');
            if (templateForm && !templateForm.dataset.listenerAttached) {
                templateForm.dataset.listenerAttached = 'true';
                
                // Color previews
                document.getElementById('templateBgColor').addEventListener('input', (e) => {
                    document.getElementById('templateBgPreview').style.background = e.target.value;
                });
                document.getElementById('templateFgColor').addEventListener('input', (e) => {
                    document.getElementById('templateFgPreview').style.background = e.target.value;
                });
                
                // Form submit
                templateForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const templateId = templateForm.dataset.templateId;
                    const template = {
                        name: document.getElementById('templateName').value.trim(),
                        level: document.getElementById('templateLevel').value,
                        summary: document.getElementById('templateSummary').value.trim(),
                        message: document.getElementById('templateMessage').value.trim(),
                        background_color: document.getElementById('templateBgColor').value.trim(),
                        foreground_color: document.getElementById('templateFgColor').value.trim()
                    };

                    const audioFile = document.getElementById('templateAudioFile')?.value.trim();
                    if (audioFile) template.audio_file = audioFile;

                    const site = document.getElementById('templateSite').value.trim();
                    if (site) template.site = site;

                    const contactName = document.getElementById('templateContactName').value.trim();
                    const contactPhone = document.getElementById('templateContactPhone').value.trim();
                    const contactEmail = document.getElementById('templateContactEmail').value.trim();
                    const contactTeams = document.getElementById('templateContactTeams').value.trim();

                    if (contactName) template.alert_contact_name = contactName;
                    if (contactPhone) template.alert_contact_phone = contactPhone;
                    if (contactEmail) template.alert_contact_email = contactEmail;
                    if (contactTeams) template.alert_contact_teams = contactTeams;

                    try {
                        const url = templateId ? `${API_BASE}/templates/${templateId}` : `${API_BASE}/templates`;
                        const method = templateId ? 'PUT' : 'POST';
                        
                        const res = await fetch(url, {
                            method: method,
                            headers,
                            body: JSON.stringify(template)
                        });

                        if (res.ok) {
                            showTemplateStatus('Template saved successfully', false);
                            setTimeout(() => {
                                document.getElementById('templateModal').style.display = 'none';
                                loadTemplates();
                            }, 1000);
                        } else {
                            const err = await res.json();
                            showTemplateStatus('Error: ' + (err.error || 'Failed to save template'), true);
                        }
                    } catch (err) {
                        showTemplateStatus('Error: ' + err.message, true);
                    }
                });
            }

            // Cancel template button
            const cancelTemplateBtn = document.getElementById('cancelTemplateBtn');
            if (cancelTemplateBtn && !cancelTemplateBtn.dataset.listenerAttached) {
                cancelTemplateBtn.dataset.listenerAttached = 'true';
                cancelTemplateBtn.addEventListener('click', () => {
                    document.getElementById('templateModal').style.display = 'none';
                });
            }

            // Close template modal on outside click
            const templateModal = document.getElementById('templateModal');
            if (templateModal && !templateModal.dataset.listenerAttached) {
                templateModal.dataset.listenerAttached = 'true';
                templateModal.addEventListener('click', (e) => {
                    if (e.target === templateModal) {
                        cancelTemplateBtn.click();
                    }
                });
            }

            // showTemplateStatus is defined earlier in global scope

            // Site target change handler
            document.querySelectorAll('input[name="siteTarget"]').forEach(radio => {
                if (!radio.dataset.listenerAttached) {
                    radio.dataset.listenerAttached = 'true';
                    radio.addEventListener('change', (e) => {
                        document.getElementById('siteCheckboxes').style.display = e.target.value === 'selected' ? 'block' : 'none';
                    });
                }
            });

            // Alert source change handler
            const alertSource = document.getElementById('alertSource');
            if (alertSource && !alertSource.dataset.listenerAttached) {
                alertSource.dataset.listenerAttached = 'true';
                alertSource.addEventListener('change', (e) => {
                    const isTemplate = e.target.value === 'template';
                    document.getElementById('templateSelect').style.display = isTemplate ? 'block' : 'none';
                    if (isTemplate) loadTemplatesForSelect();
                });
            }

            // Save defaults button
            const saveDefaultsBtn = document.getElementById('saveDefaultsBtn');
            if (saveDefaultsBtn && !saveDefaultsBtn.dataset.listenerAttached) {
                saveDefaultsBtn.dataset.listenerAttached = 'true';
                saveDefaultsBtn.addEventListener('click', async () => {
                    try {
                        const defaults = {
                            default_contact_name: document.getElementById('default_contact_name').value.trim(),
                            default_contact_phone: document.getElementById('default_contact_phone').value.trim(),
                            default_contact_email: document.getElementById('default_contact_email').value.trim(),
                            default_contact_teams: document.getElementById('default_contact_teams').value.trim()
                        };

                        const res = await fetch(`${API_BASE}/settings`, {
                            method: 'POST',
                            headers,
                            body: JSON.stringify(defaults)
                        });

                        if (res.ok) {
                            showStatus('Default contact information saved');
                        } else {
                            const err = await res.json();
                            showStatus('Error: ' + (err.error || 'Failed to save defaults'), true);
                        }
                    } catch (err) {
                        showStatus('Error: ' + err.message, true);
                    }
                });
            }

            // Change key button in settings
            const changeKeyBtnSettings = document.getElementById('changeKeyBtnSettings');
            if (changeKeyBtnSettings && !changeKeyBtnSettings.dataset.listenerAttached) {
                changeKeyBtnSettings.dataset.listenerAttached = 'true';
                changeKeyBtnSettings.addEventListener('click', () => {
                    document.getElementById('changeKeyBtn').click();
                });
            }
        }

        function hideMainContent() {
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';
            sessionStorage.removeItem('admin_key');
        }

        async function authenticate(key) {
            clearAuthError();
            
            const result = await validateAdminKey(key);
            if (result.valid) {
                ADMIN_KEY = key.trim();
                headers['X-Admin-Key'] = ADMIN_KEY;
                sessionStorage.setItem('admin_key', ADMIN_KEY);
                showMainContent();
                // Load initial data
                const alert = await loadCurrentAlert();
                populateForm(alert);
            } else {
                showAuthError(result.error || 'Invalid admin key. Please try again.');
                document.getElementById('authKey').value = '';
                document.getElementById('authKey').focus();
            }
        }

        // Authentication button handler
        document.getElementById('authBtn').addEventListener('click', async () => {
            const key = document.getElementById('authKey').value;
            await authenticate(key);
        });

        // Allow Enter key to authenticate
        document.getElementById('authKey').addEventListener('keypress', async (e) => {
            if (e.key === 'Enter') {
                const key = document.getElementById('authKey').value;
                await authenticate(key);
            }
        });

        // Initialize: Check for stored key, URL param, or prompt
        (async () => {
            // Try sessionStorage first
            let key = sessionStorage.getItem('admin_key');
            
            // Then try URL parameter
            if (!key) {
                key = new URLSearchParams(window.location.search).get('key');
            }
            
            // If we have a key, try to authenticate
            if (key) {
                document.getElementById('authKey').value = key;
                await authenticate(key);
            } else {
                // No key found, show auth screen
                hideMainContent();
            }
        })();

        // Color preview updates - moved to attachEventListeners

        // Handle authentication errors
        function handleAuthError() {
            hideMainContent();
            showAuthError('Session expired. Please authenticate again.');
            document.getElementById('authKey').focus();
        }

        // Template modal functions (defined early so they're accessible)
        function openTemplateModal(template = null) {
            console.log('openTemplateModal called', template ? 'with template' : 'new template');
            const modal = document.getElementById('templateModal');
            if (!modal) {
                console.error('Template modal not found!');
                alert('Template modal not found in page. Please refresh.');
                return;
            }
            const title = document.getElementById('templateModalTitle');
            const form = document.getElementById('templateForm');
            if (!title || !form) {
                console.error('Template modal elements not found!');
                alert('Template form elements not found. Please refresh.');
                return;
            }
            
            if (template) {
                title.textContent = 'Edit Template';
                form.dataset.templateId = template.id;
                document.getElementById('templateName').value = template.name || '';
                document.getElementById('templateLevel').value = template.level || 'routine';
                document.getElementById('templateSummary').value = template.summary || '';
                document.getElementById('templateMessage').value = template.message || '';
                document.getElementById('templateBgColor').value = template.background_color || '#B00020';
                document.getElementById('templateFgColor').value = template.foreground_color || '#FFFFFF';
                document.getElementById('templateContactName').value = template.alert_contact_name || '';
                document.getElementById('templateContactPhone').value = template.alert_contact_phone || '';
                document.getElementById('templateContactEmail').value = template.alert_contact_email || '';
                document.getElementById('templateContactTeams').value = template.alert_contact_teams || '';
                document.getElementById('templateBgPreview').style.background = template.background_color || '#B00020';
                document.getElementById('templateFgPreview').style.background = template.foreground_color || '#FFFFFF';
                
                // Load sites and set selected
                loadSitesForTemplate().then(() => {
                    if (template.site) {
                        document.getElementById('templateSite').value = template.site;
                    }
                });
            } else {
                title.textContent = 'Create Template';
                form.dataset.templateId = '';
                form.reset();
                document.getElementById('templateBgColor').value = '#B00020';
                document.getElementById('templateFgColor').value = '#FFFFFF';
                document.getElementById('templateBgPreview').style.background = '#B00020';
                document.getElementById('templateFgPreview').style.background = '#FFFFFF';
                loadSitesForTemplate();
                loadAudioFiles(); // Load audio files for dropdown
                loadDefaultContactsIntoTemplate();
            }
            
            modal.style.display = 'flex';
        }

        async function loadSitesForTemplate() {
            try {
                const res = await fetch(`${API_BASE}/sites`, { headers });
                if (res.ok) {
                    const data = await res.json();
                    const select = document.getElementById('templateSite');
                    select.innerHTML = '<option value="">All Sites</option>' +
                        data.sites.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
                }
            } catch (err) {
                console.error('Error loading sites:', err);
            }
        }

        function loadDefaultContactsIntoTemplate() {
            const name = document.getElementById('default_contact_name')?.value || '';
            const phone = document.getElementById('default_contact_phone')?.value || '';
            const email = document.getElementById('default_contact_email')?.value || '';
            const teams = document.getElementById('default_contact_teams')?.value || '';
            
            if (name) document.getElementById('templateContactName').value = name;
            if (phone) document.getElementById('templateContactPhone').value = phone;
            if (email) document.getElementById('templateContactEmail').value = email;
            if (teams) document.getElementById('templateContactTeams').value = teams;
        }

        function showTemplateStatus(message, isError = false) {
            const status = document.getElementById('templateStatus');
            if (!status) return;
            status.textContent = message;
            status.className = 'status ' + (isError ? 'error' : 'success');
            status.style.display = 'block';
            setTimeout(() => { status.style.display = 'none'; }, 5000);
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                // Update tab buttons
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                // Update tab content
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.getElementById(`tab-${tabName}`).classList.add('active');
                
                // Load data when switching to certain tabs
                if (tabName === 'templates') loadTemplates();
                if (tabName === 'sites') loadSites();
                if (tabName === 'systems') loadSystems();
                if (tabName === 'audio') loadAudioFiles();
                if (tabName === 'settings') loadSettings();
                if (tabName === 'alerts') loadAudioFiles(); // Load audio files for alert form
            });
        });

        // Templates management
        async function loadTemplates() {
            try {
                const res = await fetch(`${API_BASE}/templates`, { headers });
                if (res.status === 401) {
                    handleAuthError();
                    return;
                }
                const data = await res.json();
                renderTemplates(data.templates || []);
            } catch (err) {
                document.getElementById('templatesList').innerHTML = '<div class="status error">Error loading templates: ' + err.message + '</div>';
            }
        }

        function renderTemplates(templates) {
            const container = document.getElementById('templatesList');
            if (templates.length === 0) {
                container.innerHTML = '<p>No templates yet. Click "New Template" to create one.</p>';
                return;
            }
            container.innerHTML = templates.map(t => `
                <div class="list-item">
                    <div>
                        <strong>${t.name}</strong> (${t.level})
                        <div style="font-size: 12px; color: #666; margin-top: 4px;">${t.summary}</div>
                    </div>
                    <div class="list-item-actions">
                        <button class="btn-primary btn-small" onclick="useTemplate('${t.id}')">Use</button>
                        <button class="btn-secondary btn-small" onclick="editTemplate('${t.id}')">Edit</button>
                        <button class="btn-danger btn-small" onclick="deleteTemplate('${t.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        window.useTemplate = async function(templateId) {
            try {
                const res = await fetch(`${API_BASE}/templates`, { headers });
                const data = await res.json();
                const template = data.templates.find(t => t.id === templateId);
                if (template) {
                    // Switch to alerts tab and populate form
                    document.querySelector('[data-tab="alerts"]').click();
                    populateFormFromTemplate(template);
                }
            } catch (err) {
                showStatus('Error loading template: ' + err.message, true);
            }
        };

        window.editTemplate = async function(templateId) {
            try {
                const res = await fetch(`${API_BASE}/templates`, { headers });
                if (res.status === 401) {
                    handleAuthError();
                    return;
                }
                const data = await res.json();
                const template = data.templates.find(t => t.id === templateId);
                if (template) {
                    openTemplateModal(template);
                } else {
                    showStatus('Template not found', true);
                }
            } catch (err) {
                showStatus('Error loading template: ' + err.message, true);
            }
        };

        window.deleteTemplate = async function(templateId) {
            if (!confirm('Delete this template?')) return;
            try {
                const res = await fetch(`${API_BASE}/templates/${templateId}`, {
                    method: 'DELETE',
                    headers
                });
                if (res.ok) {
                    loadTemplates();
                    showStatus('Template deleted');
                } else {
                    showStatus('Error deleting template', true);
                }
            } catch (err) {
                showStatus('Error: ' + err.message, true);
            }
        };

        function populateFormFromTemplate(template) {
            document.getElementById('level').value = template.level;
            document.getElementById('summary').value = template.summary;
            document.getElementById('message').value = template.message;
            document.getElementById('background_color').value = template.background_color;
            document.getElementById('foreground_color').value = template.foreground_color;
            document.getElementById('contact_name').value = template.alert_contact_name || '';
            document.getElementById('contact_phone').value = template.alert_contact_phone || '';
            document.getElementById('contact_email').value = template.alert_contact_email || '';
            document.getElementById('contact_teams').value = template.alert_contact_teams || '';
            if (template.audio_file) {
                document.getElementById('audioFile').value = template.audio_file;
            } else {
                document.getElementById('audioFile').value = '';
            }
            document.getElementById('bgPreview').style.background = template.background_color;
            document.getElementById('fgPreview').style.background = template.foreground_color;
            
            // Handle site selection - template may have a site, but user can override
            if (template.site) {
                // Template has a site - set to "Selected Sites" and check that site
                document.querySelector('input[name="siteTarget"][value="selected"]').checked = true;
                document.getElementById('siteCheckboxes').style.display = 'block';
                
                // Wait for checkboxes to be populated, then check the template's site
                setTimeout(() => {
                    const checkboxes = document.querySelectorAll('input[name="selectedSites"]');
                    checkboxes.forEach(cb => {
                        if (cb.value === template.site) {
                            cb.checked = true;
                        }
                    });
                }, 100);
            } else {
                // Template has no site - default to "All Sites"
                document.querySelector('input[name="siteTarget"][value="all"]').checked = true;
                document.getElementById('siteCheckboxes').style.display = 'none';
            }
        }

        // Sites management
        async function loadSites() {
            try {
                const res = await fetch(`${API_BASE}/sites`, { headers });
                if (res.status === 401) {
                    handleAuthError();
                    return;
                }
                const data = await res.json();
                renderSites(data.sites || []);
                updateSiteCheckboxes(data.sites || []);
            } catch (err) {
                document.getElementById('sitesList').innerHTML = '<div class="status error">Error loading sites: ' + err.message + '</div>';
            }
        }

        function renderSites(sites) {
            const container = document.getElementById('sitesList');
            if (sites.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><p style="margin-bottom: 10px;">No sites configured yet.</p><p style="font-size: 14px;">Click "New Site" to create your first site.</p></div>';
                return;
            }
            container.innerHTML = sites.map(s => `
                <div class="list-item" style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: box-shadow 0.2s;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 18px;">
                                ${s.name.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <strong style="font-size: 16px; color: #333;">${s.name}</strong>
                                <div style="font-size: 12px; color: #666; margin-top: 2px;">Site ID: ${s.id}</div>
                            </div>
                        </div>
                    </div>
                    <div class="list-item-actions">
                        <button class="btn-secondary btn-small" onclick="editSite('${s.id}')" style="min-width: 70px;">Edit</button>
                        <button class="btn-danger btn-small" onclick="deleteSite('${s.id}')" style="min-width: 70px;">Delete</button>
                    </div>
                </div>
            `).join('');
            
            // Add hover effect
            container.querySelectorAll('.list-item').forEach(item => {
                item.addEventListener('mouseenter', () => {
                    item.style.boxShadow = '0 4px 8px rgba(0,0,0,0.15)';
                    item.style.transform = 'translateY(-2px)';
                });
                item.addEventListener('mouseleave', () => {
                    item.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
                    item.style.transform = 'translateY(0)';
                });
            });
        }

        function updateSiteCheckboxes(sites) {
            const container = document.getElementById('siteCheckboxes');
            if (!container) return;
            
            if (sites.length === 0) {
                container.innerHTML = '<p style="color: #666; font-size: 14px; padding: 12px; text-align: center;">No sites available. Create sites in the Sites tab first.</p>';
                return;
            }
            
            container.innerHTML = sites.map(s => `
                <label style="display: flex; align-items: center; padding: 10px; margin-bottom: 6px; border-radius: 6px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background=''">
                    <input type="checkbox" name="selectedSites" value="${s.name}" style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
                    <span style="font-size: 14px; color: #333;">${s.name}</span>
                </label>
            `).join('');
        }

        window.editSite = function(siteId) {
            // Get current site name
            const currentName = document.querySelector(`[onclick="editSite('${siteId}')"]`)?.closest('.list-item')?.querySelector('strong')?.textContent || '';
            const name = prompt('Enter new site name:', currentName);
            if (!name || name.trim().length === 0) return;
            
            fetch(`${API_BASE}/sites/${siteId}`, {
                method: 'PUT',
                headers,
                body: JSON.stringify({ name: name.trim() })
            }).then(res => {
                if (res.ok) {
                    loadSites();
                    updateSiteCheckboxes([]); // Will be updated when loadSites completes
                    showStatus('Site updated successfully');
                } else {
                    showStatus('Error updating site', true);
                }
            }).catch(err => showStatus('Error: ' + err.message, true));
        };

        window.deleteSite = async function(siteId) {
            if (!confirm('Delete this site?')) return;
            try {
                const res = await fetch(`${API_BASE}/sites/${siteId}`, {
                    method: 'DELETE',
                    headers
                });
                if (res.ok) {
                    loadSites();
                    showStatus('Site deleted');
                } else {
                    showStatus('Error deleting site', true);
                }
            } catch (err) {
                showStatus('Error: ' + err.message, true);
            }
        };

        // Systems monitoring with filtering, sorting, and pagination
        let allSystems = [];
        let filteredSystems = [];
        let currentPage = 1;
        let systemsPerPage = 25;
        let currentSort = { field: 'last_seen', direction: 'desc' };

        async function loadSystems() {
            try {
                const res = await fetch(`${API_BASE}/systems`, { headers });
                if (res.status === 401) {
                    handleAuthError();
                    return;
                }
                const data = await res.json();
                allSystems = data.systems || [];
                applyFiltersAndRender();
            } catch (err) {
                document.getElementById('systemsTableBody').innerHTML = '<tr><td colspan="7" style="color: #dc3545; text-align: center; padding: 20px;">Error loading systems: ' + err.message + '</td></tr>';
            }
        }

        function applyFiltersAndRender() {
            // Apply filters
            const filterWorkstation = document.getElementById('filterWorkstation').value.toLowerCase();
            const filterCompany = document.getElementById('filterCompany').value.toLowerCase();
            const filterSite = document.getElementById('filterSite').value.toLowerCase();
            const filterCompliance = document.getElementById('filterCompliance').value;

            filteredSystems = allSystems.filter(s => {
                const workstationMatch = !filterWorkstation || (s.workstation_name || '').toLowerCase().includes(filterWorkstation);
                const companyMatch = !filterCompany || (s.company || '').toLowerCase().includes(filterCompany);
                const siteMatch = !filterSite || (s.location || '').toLowerCase().includes(filterSite);
                const complianceMatch = filterCompliance === '' || String(s.compliance_status || 0) === filterCompliance;
                return workstationMatch && companyMatch && siteMatch && complianceMatch;
            });

            // Apply sorting
            filteredSystems.sort((a, b) => {
                let aVal, bVal;
                switch (currentSort.field) {
                    case 'workstation_name':
                        aVal = (a.workstation_name || '').toLowerCase();
                        bVal = (b.workstation_name || '').toLowerCase();
                        break;
                    case 'username':
                        aVal = (a.username || '').toLowerCase();
                        bVal = (b.username || '').toLowerCase();
                        break;
                    case 'company':
                        aVal = (a.company || '').toLowerCase();
                        bVal = (b.company || '').toLowerCase();
                        break;
                    case 'classification':
                        aVal = (a.classification || '').toLowerCase();
                        bVal = (b.classification || '').toLowerCase();
                        break;
                    case 'location':
                        aVal = (a.location || '').toLowerCase();
                        bVal = (b.location || '').toLowerCase();
                        break;
                    case 'compliance_status':
                        aVal = a.compliance_status || 0;
                        bVal = b.compliance_status || 0;
                        break;
                    case 'last_seen':
                    default:
                        aVal = a.last_seen ? new Date(a.last_seen).getTime() : 0;
                        bVal = b.last_seen ? new Date(b.last_seen).getTime() : 0;
                        break;
                }
                
                if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            // Update pagination
            const totalPages = Math.ceil(filteredSystems.length / systemsPerPage);
            if (currentPage > totalPages && totalPages > 0) currentPage = totalPages;
            if (currentPage < 1) currentPage = 1;

            // Get page data
            const startIdx = (currentPage - 1) * systemsPerPage;
            const endIdx = startIdx + systemsPerPage;
            const pageSystems = filteredSystems.slice(startIdx, endIdx);

            renderSystems(pageSystems);
            updatePagination(filteredSystems.length, totalPages);
            updateSortIndicators();
        }

        function renderSystems(systems) {
            const tbody = document.getElementById('systemsTableBody');
            if (systems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666; padding: 40px;">No systems match the current filters.</td></tr>';
                return;
            }

            tbody.innerHTML = systems.map(s => {
                const lastSeen = s.last_seen ? new Date(s.last_seen).toLocaleString() : 'Never';
                const timeAgo = s.last_seen ? getTimeAgo(new Date(s.last_seen)) : '';
                
                // Parse location (comma-separated sites)
                const locations = (s.location || '').split(',').map(l => l.trim()).filter(l => l);
                const primaryLocation = locations[0] || 'Unknown';
                const additionalLocations = locations.slice(1);
                const locationDisplay = additionalLocations.length > 0 
                    ? `${primaryLocation} <span style="background: #667eea; color: white; border-radius: 10px; padding: 2px 8px; font-size: 11px; font-weight: bold; margin-left: 6px;">+${additionalLocations.length}</span>`
                    : primaryLocation;
                const locationTooltip = additionalLocations.length > 0
                    ? `Primary Site: ${primaryLocation}\n\nAdditional Site(s):\n${additionalLocations.join('\n')}`
                    : '';

                // Classification with colors
                const bgColor = s.background_color || '#FFA500';
                const fgColor = s.foreground_color || '#FFFFFF';
                
                // Compliance status
                const complianceStatus = s.compliance_status !== undefined ? s.compliance_status : 0;
                const complianceText = complianceStatus === 1 ? 'Compliant' : 'Not Compliant';
                const complianceBg = complianceStatus === 1 ? '#28a745' : '#dc3545';
                
                return `
                    <tr style="border-bottom: 1px solid #e0e0e0;">
                        <td style="padding: 12px;"><strong>${s.workstation_name || 'Unknown'}</strong></td>
                        <td style="padding: 12px;">${s.username || 'Unknown'}</td>
                        <td style="padding: 12px;">${s.company || 'Unknown'}</td>
                        <td style="padding: 12px;">
                            <span style="background: ${bgColor}; color: ${fgColor}; padding: 4px 12px; border-radius: 4px; font-size: 12px; font-weight: 600; display: inline-block;">
                                ${s.classification || 'Unknown'}
                            </span>
                        </td>
                        <td style="padding: 12px;" ${locationTooltip ? `title="${locationTooltip}"` : ''}>
                            ${locationDisplay}
                        </td>
                        <td style="padding: 12px;">
                            <span style="background: ${complianceBg}; color: white; padding: 4px 12px; border-radius: 4px; font-size: 12px; font-weight: 600; display: inline-block;">
                                ${complianceText}
                            </span>
                        </td>
                        <td style="padding: 12px; font-size: 13px;">
                            ${lastSeen}${timeAgo ? '<br><small style="color: #666;">' + timeAgo + '</small>' : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updatePagination(total, totalPages) {
            document.getElementById('systemsShowing').textContent = 
                filteredSystems.length === 0 ? '0' : 
                `${(currentPage - 1) * systemsPerPage + 1}-${Math.min(currentPage * systemsPerPage, total)}`;
            document.getElementById('systemsTotal').textContent = total;
            document.getElementById('systemsPageInfo').textContent = `Page ${currentPage} of ${totalPages || 1}`;
            
            document.getElementById('systemsPrevBtn').disabled = currentPage <= 1;
            document.getElementById('systemsNextBtn').disabled = currentPage >= totalPages;
        }

        function updateSortIndicators() {
            document.querySelectorAll('#systemsTable th[data-sort]').forEach(th => {
                const indicator = th.querySelector('.sort-indicator');
                if (th.dataset.sort === currentSort.field) {
                    indicator.textContent = currentSort.direction === 'asc' ? ' ' : ' ';
                    indicator.style.color = '#007bff';
                } else {
                    indicator.textContent = ' ';
                    indicator.style.color = '#ccc';
                }
            });
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
            return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
        }

        // New site button
        document.getElementById('newSiteBtn').addEventListener('click', async () => {
            const name = prompt('Enter site name:');
            if (!name || name.trim().length === 0) return;
            try {
                const res = await fetch(`${API_BASE}/sites`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ name: name.trim() })
                });
                if (res.ok) {
                    loadSites();
                    showStatus('Site created');
                } else {
                    showStatus('Error creating site', true);
                }
            } catch (err) {
                showStatus('Error: ' + err.message, true);
            }
        });

        // New template button, Save as template - moved to attachEventListeners

        // Refresh systems button
        const refreshSystemsBtn = document.getElementById('refreshSystemsBtn');
        if (refreshSystemsBtn) {
            refreshSystemsBtn.addEventListener('click', loadSystems);
        }

        // Systems filtering, sorting, and pagination
        const filterWorkstation = document.getElementById('filterWorkstation');
        const filterCompany = document.getElementById('filterCompany');
        const filterSite = document.getElementById('filterSite');
        const filterCompliance = document.getElementById('filterCompliance');
        const clearFiltersBtn = document.getElementById('clearFiltersBtn');
        const systemsPrevBtn = document.getElementById('systemsPrevBtn');
        const systemsNextBtn = document.getElementById('systemsNextBtn');
        const systemsPerPageSelect = document.getElementById('systemsPerPage');

        if (filterWorkstation) filterWorkstation.addEventListener('input', applyFiltersAndRender);
        if (filterCompany) filterCompany.addEventListener('input', applyFiltersAndRender);
        if (filterSite) filterSite.addEventListener('input', applyFiltersAndRender);
        if (filterCompliance) filterCompliance.addEventListener('change', applyFiltersAndRender);
        if (clearFiltersBtn) {
            clearFiltersBtn.addEventListener('click', () => {
                if (filterWorkstation) filterWorkstation.value = '';
                if (filterCompany) filterCompany.value = '';
                if (filterSite) filterSite.value = '';
                if (filterCompliance) filterCompliance.value = '';
                currentPage = 1;
                applyFiltersAndRender();
            });
        }
        if (systemsPrevBtn) {
            systemsPrevBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    applyFiltersAndRender();
                }
            });
        }
        if (systemsNextBtn) {
            systemsNextBtn.addEventListener('click', () => {
                const totalPages = Math.ceil(filteredSystems.length / systemsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    applyFiltersAndRender();
                }
            });
        }
        if (systemsPerPageSelect) {
            systemsPerPageSelect.addEventListener('change', (e) => {
                systemsPerPage = parseInt(e.target.value);
                currentPage = 1;
                applyFiltersAndRender();
            });
        }

        // Column sorting
        document.querySelectorAll('#systemsTable th[data-sort]').forEach(th => {
            th.addEventListener('click', () => {
                const field = th.dataset.sort;
                if (currentSort.field === field) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.field = field;
                    currentSort.direction = 'asc';
                }
                currentPage = 1;
                applyFiltersAndRender();
            });
        });

        // Settings tab functions
        async function loadSettings() {
            try {
                // Load default contacts from server config
                const res = await fetch(`${API_BASE}/settings`, { headers });
                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('default_contact_name').value = data.default_contact_name || '';
                    document.getElementById('default_contact_phone').value = data.default_contact_phone || '';
                    document.getElementById('default_contact_email').value = data.default_contact_email || '';
                    document.getElementById('default_contact_teams').value = data.default_contact_teams || '';
                }
            } catch (err) {
                // Settings endpoint might not exist yet, that's ok
            }
        }

        function loadDefaultContacts() {
            // Load defaults into form when creating new alert/template
            const name = document.getElementById('default_contact_name').value;
            const phone = document.getElementById('default_contact_phone').value;
            const email = document.getElementById('default_contact_email').value;
            const teams = document.getElementById('default_contact_teams').value;
            
            if (name && !document.getElementById('contact_name').value) {
                document.getElementById('contact_name').value = name;
            }
            if (phone && !document.getElementById('contact_phone').value) {
                document.getElementById('contact_phone').value = phone;
            }
            if (email && !document.getElementById('contact_email').value) {
                document.getElementById('contact_email').value = email;
            }
            if (teams && !document.getElementById('contact_teams').value) {
                document.getElementById('contact_teams').value = teams;
            }
        }

        // Change key button, Save defaults - moved to attachEventListeners

        // Alert source change handler, Site target - moved to attachEventListeners

        async function loadTemplatesForSelect() {
            try {
                const res = await fetch(`${API_BASE}/templates`, { headers });
                const data = await res.json();
                const select = document.getElementById('templateSelect');
                select.innerHTML = '<option value="">Select a template...</option>' +
                    data.templates.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
                select.addEventListener('change', (e) => {
                    if (e.target.value) useTemplate(e.target.value);
                });
            } catch (err) {
                console.error('Error loading templates:', err);
            }
        }

        // Load current alert
        async function loadCurrentAlert() {
            try {
                const res = await fetch(`${API_BASE}/alert`);
                if (res.status === 204) {
                    document.getElementById('currentAlertContent').textContent = 'No active alert';
                    return null;
                }
                if (res.status === 401) {
                    handleAuthError();
                    return null;
                }
                const alert = await res.json();
                document.getElementById('currentAlertContent').textContent = JSON.stringify(alert, null, 2);
                return alert;
            } catch (err) {
                document.getElementById('currentAlertContent').textContent = 'Error: ' + err.message;
                return null;
            }
        }

        // Populate form from alert
        function populateForm(alert) {
            if (!alert) return;
            document.getElementById('level').value = alert.level || 'routine';
            document.getElementById('summary').value = alert.summary || '';
            document.getElementById('message').value = alert.message || '';
            document.getElementById('background_color').value = alert.background_color || '#B00020';
            document.getElementById('foreground_color').value = alert.foreground_color || '#FFFFFF';
            document.getElementById('contact_name').value = alert.alert_contact_name || '';
            document.getElementById('contact_phone').value = alert.alert_contact_phone || '';
            document.getElementById('contact_email').value = alert.alert_contact_email || '';
            document.getElementById('contact_teams').value = alert.alert_contact_teams || '';
            document.getElementById('site').value = alert.site || '';
            if (alert.audio_file) {
                document.getElementById('audioFile').value = alert.audio_file;
            } else {
                document.getElementById('audioFile').value = '';
            }
            
            document.getElementById('bgPreview').style.background = alert.background_color || '#B00020';
            document.getElementById('fgPreview').style.background = alert.foreground_color || '#FFFFFF';
        }

        // Show status message
        function showStatus(message, isError = false) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + (isError ? 'error' : 'success');
            status.style.display = 'block';
            setTimeout(() => { status.style.display = 'none'; }, 5000);
        }

        // Form submit, Clear, Refresh - moved to attachEventListeners

        // Audio file management
        async function loadAudioFiles() {
            try {
                const res = await fetch(`${API_BASE}/audio`, { headers });
                if (res.status === 401) {
                    handleAuthError();
                    return;
                }
                const data = await res.json();
                renderAudioFiles(data.audio_files || []);
                updateAudioSelect(data.audio_files || []);
            } catch (err) {
                document.getElementById('audioList').innerHTML = '<div class="status error">Error loading audio files: ' + err.message + '</div>';
            }
        }

        function renderAudioFiles(audioFiles) {
            const container = document.getElementById('audioList');
            if (audioFiles.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><p style="margin-bottom: 10px;">No audio files uploaded yet.</p><p style="font-size: 14px;">Click "Upload Audio" to add your first audio file.</p></div>';
                return;
            }
            container.innerHTML = audioFiles.map(a => {
                const sizeKB = (a.size / 1024).toFixed(1);
                const uploaded = new Date(a.uploaded).toLocaleString();
                return `
                    <div class="list-item" style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px;">
                                    
                                </div>
                                <div>
                                    <strong style="font-size: 16px; color: #333;" id="audio-name-${a.id}">${a.name}</strong>
                                    <div style="font-size: 12px; color: #666; margin-top: 2px;">${a.filename}  ${sizeKB} KB  Uploaded: ${uploaded}</div>
                                </div>
                            </div>
                        </div>
                        <div class="list-item-actions">
                            <button class="btn-secondary btn-small" onclick="editAudioName('${a.id}')" style="min-width: 70px;">Rename</button>
                            <button class="btn-danger btn-small" onclick="deleteAudio('${a.id}')" style="min-width: 70px;">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateAudioSelect(audioFiles) {
            const select = document.getElementById('audioFile');
            const templateSelect = document.getElementById('templateAudioFile');
            
            if (select) {
                select.innerHTML = '<option value="">Default System Beep</option>' +
                    audioFiles.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
            }
            
            if (templateSelect) {
                templateSelect.innerHTML = '<option value="">Default System Beep</option>' +
                    audioFiles.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
            }
        }

        window.editAudioName = function(audioId) {
            const currentName = document.getElementById(`audio-name-${audioId}`)?.textContent || '';
            const name = prompt('Enter new audio file name:', currentName);
            if (!name || name.trim().length === 0) return;
            
            fetch(`${API_BASE}/audio/${audioId}`, {
                method: 'PUT',
                headers,
                body: JSON.stringify({ name: name.trim() })
            }).then(res => {
                if (res.ok) {
                    loadAudioFiles();
                    showStatus('Audio file renamed successfully');
                } else {
                    res.json().then(err => showStatus('Error: ' + (err.error || 'Failed to rename'), true));
                }
            }).catch(err => showStatus('Error: ' + err.message, true));
        };

        window.deleteAudio = async function(audioId) {
            if (!confirm('Delete this audio file?')) return;
            try {
                const res = await fetch(`${API_BASE}/audio/${audioId}`, {
                    method: 'DELETE',
                    headers
                });
                if (res.ok) {
                    loadAudioFiles();
                    showStatus('Audio file deleted');
                } else {
                    const err = await res.json();
                    showStatus('Error: ' + (err.error || 'Failed to delete'), true);
                }
            } catch (err) {
                showStatus('Error: ' + err.message, true);
            }
        };

        // Upload audio button
        const uploadAudioBtn = document.getElementById('uploadAudioBtn');
        const audioFileInput = document.getElementById('audioFileInput');
        if (uploadAudioBtn && audioFileInput) {
            uploadAudioBtn.addEventListener('click', () => audioFileInput.click());
            audioFileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const formData = new FormData();
                formData.append('audio', file);
                formData.append('name', file.name.replace(/\.[^/.]+$/, ''));
                
                try {
                    const res = await fetch(`${API_BASE}/audio`, {
                        method: 'POST',
                        headers: { 'X-Admin-Key': ADMIN_KEY },
                        body: formData
                    });
                    
                    if (res.ok) {
                        loadAudioFiles();
                        showStatus('Audio file uploaded successfully');
                        audioFileInput.value = '';
                    } else {
                        const err = await res.json();
                        showStatus('Error: ' + (err.error || 'Failed to upload'), true);
                    }
                } catch (err) {
                    showStatus('Error: ' + err.message, true);
                }
            });
        }

        // Admin Key Management
        const keyModal = document.getElementById('keyModal');
        const changeKeyBtn = document.getElementById('changeKeyBtn');
        const cancelKeyBtn = document.getElementById('cancelKeyBtn');
        const saveKeyBtn = document.getElementById('saveKeyBtn');
        const newKeyInput = document.getElementById('newKey');
        const confirmKeyInput = document.getElementById('confirmKey');
        const keyStatus = document.getElementById('keyStatus');

        function showKeyStatus(message, isError = false) {
            keyStatus.textContent = message;
            keyStatus.className = 'status ' + (isError ? 'error' : 'success');
            keyStatus.style.display = 'block';
            setTimeout(() => { keyStatus.style.display = 'none'; }, 5000);
        }

        changeKeyBtn.addEventListener('click', () => {
            keyModal.style.display = 'flex';
            newKeyInput.value = '';
            confirmKeyInput.value = '';
            keyStatus.style.display = 'none';
        });

        cancelKeyBtn.addEventListener('click', () => {
            keyModal.style.display = 'none';
            newKeyInput.value = '';
            confirmKeyInput.value = '';
            keyStatus.style.display = 'none';
        });

        saveKeyBtn.addEventListener('click', async () => {
            const newKey = newKeyInput.value.trim();
            const confirmKey = confirmKeyInput.value.trim();

            if (!newKey || newKey.length < 4) {
                showKeyStatus('Admin key must be at least 4 characters', true);
                return;
            }

            if (newKey !== confirmKey) {
                showKeyStatus('Keys do not match', true);
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/admin/key`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ new_key: newKey })
                });

                if (res.ok) {
                    showKeyStatus('Admin key updated successfully! Re-authenticating...', false);
                    // Update the key and re-authenticate
                    ADMIN_KEY = newKey;
                    headers['X-Admin-Key'] = ADMIN_KEY;
                    sessionStorage.setItem('admin_key', ADMIN_KEY);
                    keyModal.style.display = 'none';
                    showKeyStatus('', false);
                } else if (res.status === 401) {
                    handleAuthError();
                    keyModal.style.display = 'none';
                } else {
                    const err = await res.json();
                    showKeyStatus('Error: ' + (err.error || 'Failed to update admin key'), true);
                }
            } catch (err) {
                showKeyStatus('Error: ' + err.message, true);
            }
        });

        // Close modal on outside click
        keyModal.addEventListener('click', (e) => {
            if (e.target === keyModal) {
                cancelKeyBtn.click();
            }
        });

        // Initial load
        (async () => {
            const alert = await loadCurrentAlert();
            populateForm(alert);
            loadDefaultContacts(); // Pre-fill defaults if form is empty
        })();
    </script>
</body>
</html>


