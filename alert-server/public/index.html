<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GridBanner Alert Server - Admin</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1a1a1a;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: #333;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }
        textarea {
            min-height: 120px;
            resize: vertical;
        }
        .color-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .color-preview {
            width: 40px;
            height: 40px;
            border: 2px solid #ddd;
            border-radius: 4px;
            margin-top: 8px;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-primary:hover { background: #0056b3; }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-danger:hover { background: #c82333; }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-secondary:hover { background: #5a6268; }
        .status {
            margin-top: 20px;
            padding: 12px;
            border-radius: 4px;
            display: none;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .current-alert {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .current-alert h3 {
            margin-bottom: 10px;
            color: #495057;
        }
        .current-alert pre {
            background: white;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        @media (max-width: 768px) {
            .grid, .color-group { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Authentication Screen -->
    <div id="authScreen" style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: #f5f5f5;">
        <div style="background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-width: 400px; width: 90%;">
            <h1 style="margin-bottom: 10px; text-align: center;">GridBanner Alert Server</h1>
            <p style="text-align: center; color: #666; margin-bottom: 30px;">Admin authentication required</p>
            <div class="form-group">
                <label for="authKey">Admin Key *</label>
                <input type="password" id="authKey" placeholder="Enter admin key" style="margin-bottom: 15px;" autofocus>
                <button type="button" class="btn-primary" id="authBtn" style="width: 100%;">Authenticate</button>
            </div>
            <div class="status" id="authStatus" style="margin-top: 15px;"></div>
        </div>
    </div>

    <!-- Main Content (hidden until authenticated) -->
    <div id="mainContent" style="display: none;">
    <div class="container">
        <h1>GridBanner Alert Server</h1>
        <p class="subtitle">Centralized alert management for GridBanner workstations</p>

        <div style="margin-bottom: 20px; padding: 15px; background: #e7f3ff; border: 1px solid #b3d9ff; border-radius: 4px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>Admin Key Management</strong>
                    <div style="font-size: 12px; color: #666; margin-top: 4px;">Change the server admin key</div>
                </div>
                <button type="button" class="btn-secondary" id="changeKeyBtn" style="margin: 0;">Change Admin Key</button>
            </div>
        </div>

        <div class="current-alert" id="currentAlert">
            <h3>Current Alert</h3>
            <pre id="currentAlertContent">Loading...</pre>
        </div>

        <form id="alertForm">
            <div class="form-group">
                <label for="level">Alert Level *</label>
                <select id="level" required>
                    <option value="routine">Routine</option>
                    <option value="urgent">Urgent</option>
                    <option value="critical">Critical</option>
                    <option value="super_critical">Super Critical</option>
                </select>
            </div>

            <div class="form-group">
                <label for="summary">Summary *</label>
                <input type="text" id="summary" required placeholder="Brief alert summary">
            </div>

            <div class="form-group">
                <label for="message">Message *</label>
                <textarea id="message" required placeholder="Full alert message text"></textarea>
            </div>

            <div class="color-group">
                <div class="form-group">
                    <label for="background_color">Background Color *</label>
                    <input type="text" id="background_color" required value="#B00020" placeholder="#FF0000">
                    <div class="color-preview" id="bgPreview" style="background: #B00020;"></div>
                </div>
                <div class="form-group">
                    <label for="foreground_color">Foreground Color *</label>
                    <input type="text" id="foreground_color" required value="#FFFFFF" placeholder="#FFFFFF">
                    <div class="color-preview" id="fgPreview" style="background: #FFFFFF;"></div>
                </div>
            </div>

            <div class="grid">
                <div class="form-group">
                    <label for="contact_name">Contact Name</label>
                    <input type="text" id="contact_name" placeholder="Optional">
                </div>
                <div class="form-group">
                    <label for="contact_phone">Contact Phone</label>
                    <input type="text" id="contact_phone" placeholder="Optional">
                </div>
                <div class="form-group">
                    <label for="contact_email">Contact Email</label>
                    <input type="email" id="contact_email" placeholder="Optional">
                </div>
                <div class="form-group">
                    <label for="contact_teams">Contact Teams</label>
                    <input type="text" id="contact_teams" placeholder="Optional (msteams: or https://)">
                </div>
            </div>

            <div class="form-group">
                <label for="site">Site (optional)</label>
                <input type="text" id="site" placeholder="Leave empty for all sites, or specify site name">
            </div>

            <div class="button-group">
                <button type="submit" class="btn-primary">Update Alert</button>
                <button type="button" class="btn-danger" id="clearBtn">Clear Alert</button>
                <button type="button" class="btn-secondary" id="refreshBtn">Refresh</button>
            </div>
        </form>

        <div class="status" id="status"></div>
    </div>
    </div>

    <!-- Change Admin Key Modal -->
    <div id="keyModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 8px; max-width: 400px; width: 90%; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
            <h2 style="margin-bottom: 20px;">Change Admin Key</h2>
            <div class="form-group">
                <label for="newKey">New Admin Key *</label>
                <input type="password" id="newKey" required placeholder="Enter new admin key (min 4 characters)" style="margin-bottom: 10px;">
                <input type="password" id="confirmKey" required placeholder="Confirm new admin key" style="margin-bottom: 10px;">
                <div style="font-size: 12px; color: #666;">The admin key must be at least 4 characters long.</div>
            </div>
            <div class="button-group" style="margin-top: 20px;">
                <button type="button" class="btn-primary" id="saveKeyBtn">Save</button>
                <button type="button" class="btn-secondary" id="cancelKeyBtn">Cancel</button>
            </div>
            <div class="status" id="keyStatus" style="margin-top: 15px;"></div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let ADMIN_KEY = null;
        let headers = { 'Content-Type': 'application/json' };

        // Authentication functions
        function showAuthError(message) {
            const authStatus = document.getElementById('authStatus');
            authStatus.textContent = message;
            authStatus.className = 'status error';
            authStatus.style.display = 'block';
        }

        function clearAuthError() {
            const authStatus = document.getElementById('authStatus');
            authStatus.style.display = 'none';
        }

        async function validateAdminKey(key) {
            if (!key || key.trim().length === 0) {
                return { valid: false, error: 'Admin key cannot be empty' };
            }

            try {
                const res = await fetch(`${API_BASE}/admin/key`, {
                    method: 'GET',
                    headers: { 'X-Admin-Key': key.trim() }
                });

                if (res.ok) {
                    return { valid: true };
                } else {
                    // Check if response is JSON
                    const contentType = res.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const err = await res.json();
                        return { valid: false, error: err.error || 'Invalid admin key' };
                    } else {
                        // Response is not JSON (probably HTML error page)
                        const text = await res.text();
                        if (res.status === 401) {
                            return { valid: false, error: 'Invalid admin key' };
                        } else if (res.status === 404) {
                            return { valid: false, error: 'API endpoint not found. Please ensure the server is running and up to date.' };
                        } else {
                            return { valid: false, error: `Server error (${res.status}). Please check the server logs.` };
                        }
                    }
                }
            } catch (err) {
                return { valid: false, error: 'Failed to connect to server: ' + err.message };
            }
        }

        function showMainContent() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }

        function hideMainContent() {
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';
            sessionStorage.removeItem('admin_key');
        }

        async function authenticate(key) {
            clearAuthError();
            
            const result = await validateAdminKey(key);
            if (result.valid) {
                ADMIN_KEY = key.trim();
                headers['X-Admin-Key'] = ADMIN_KEY;
                sessionStorage.setItem('admin_key', ADMIN_KEY);
                showMainContent();
                // Load initial data
                const alert = await loadCurrentAlert();
                populateForm(alert);
            } else {
                showAuthError(result.error || 'Invalid admin key. Please try again.');
                document.getElementById('authKey').value = '';
                document.getElementById('authKey').focus();
            }
        }

        // Authentication button handler
        document.getElementById('authBtn').addEventListener('click', async () => {
            const key = document.getElementById('authKey').value;
            await authenticate(key);
        });

        // Allow Enter key to authenticate
        document.getElementById('authKey').addEventListener('keypress', async (e) => {
            if (e.key === 'Enter') {
                const key = document.getElementById('authKey').value;
                await authenticate(key);
            }
        });

        // Initialize: Check for stored key, URL param, or prompt
        (async () => {
            // Try sessionStorage first
            let key = sessionStorage.getItem('admin_key');
            
            // Then try URL parameter
            if (!key) {
                key = new URLSearchParams(window.location.search).get('key');
            }
            
            // If we have a key, try to authenticate
            if (key) {
                document.getElementById('authKey').value = key;
                await authenticate(key);
            } else {
                // No key found, show auth screen
                hideMainContent();
            }
        })();

        // Color preview updates
        document.getElementById('background_color').addEventListener('input', (e) => {
            document.getElementById('bgPreview').style.background = e.target.value;
        });
        document.getElementById('foreground_color').addEventListener('input', (e) => {
            document.getElementById('fgPreview').style.background = e.target.value;
        });

        // Handle authentication errors
        function handleAuthError() {
            hideMainContent();
            showAuthError('Session expired. Please authenticate again.');
            document.getElementById('authKey').focus();
        }

        // Load current alert
        async function loadCurrentAlert() {
            try {
                const res = await fetch(`${API_BASE}/alert`);
                if (res.status === 204) {
                    document.getElementById('currentAlertContent').textContent = 'No active alert';
                    return null;
                }
                if (res.status === 401) {
                    handleAuthError();
                    return null;
                }
                const alert = await res.json();
                document.getElementById('currentAlertContent').textContent = JSON.stringify(alert, null, 2);
                return alert;
            } catch (err) {
                document.getElementById('currentAlertContent').textContent = 'Error: ' + err.message;
                return null;
            }
        }

        // Populate form from alert
        function populateForm(alert) {
            if (!alert) return;
            document.getElementById('level').value = alert.level || 'routine';
            document.getElementById('summary').value = alert.summary || '';
            document.getElementById('message').value = alert.message || '';
            document.getElementById('background_color').value = alert.background_color || '#B00020';
            document.getElementById('foreground_color').value = alert.foreground_color || '#FFFFFF';
            document.getElementById('contact_name').value = alert.alert_contact_name || '';
            document.getElementById('contact_phone').value = alert.alert_contact_phone || '';
            document.getElementById('contact_email').value = alert.alert_contact_email || '';
            document.getElementById('contact_teams').value = alert.alert_contact_teams || '';
            document.getElementById('site').value = alert.site || '';
            
            document.getElementById('bgPreview').style.background = alert.background_color || '#B00020';
            document.getElementById('fgPreview').style.background = alert.foreground_color || '#FFFFFF';
        }

        // Show status message
        function showStatus(message, isError = false) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + (isError ? 'error' : 'success');
            status.style.display = 'block';
            setTimeout(() => { status.style.display = 'none'; }, 5000);
        }

        // Form submit
        document.getElementById('alertForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const alert = {
                level: document.getElementById('level').value,
                summary: document.getElementById('summary').value,
                message: document.getElementById('message').value,
                background_color: document.getElementById('background_color').value,
                foreground_color: document.getElementById('foreground_color').value
            };

            const contactName = document.getElementById('contact_name').value.trim();
            const contactPhone = document.getElementById('contact_phone').value.trim();
            const contactEmail = document.getElementById('contact_email').value.trim();
            const contactTeams = document.getElementById('contact_teams').value.trim();
            const site = document.getElementById('site').value.trim();

            if (contactName) alert.alert_contact_name = contactName;
            if (contactPhone) alert.alert_contact_phone = contactPhone;
            if (contactEmail) alert.alert_contact_email = contactEmail;
            if (contactTeams) alert.alert_contact_teams = contactTeams;
            if (site) alert.site = site;

            try {
                const res = await fetch(`${API_BASE}/alert`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(alert)
                });

                if (res.ok) {
                    showStatus('Alert updated successfully');
                    await loadCurrentAlert();
                } else if (res.status === 401) {
                    handleAuthError();
                } else {
                    const err = await res.json();
                    showStatus('Error: ' + (err.error || 'Failed to update alert'), true);
                }
            } catch (err) {
                showStatus('Error: ' + err.message, true);
            }
        });

        // Clear alert
        document.getElementById('clearBtn').addEventListener('click', async () => {
            if (!confirm('Clear the current alert?')) return;
            try {
                const res = await fetch(`${API_BASE}/alert`, {
                    method: 'DELETE',
                    headers
                });

                if (res.ok) {
                    showStatus('Alert cleared');
                    await loadCurrentAlert();
                    document.getElementById('alertForm').reset();
                } else if (res.status === 401) {
                    handleAuthError();
                } else {
                    const err = await res.json();
                    showStatus('Error: ' + (err.error || 'Failed to clear alert'), true);
                }
            } catch (err) {
                showStatus('Error: ' + err.message, true);
            }
        });

        // Refresh
        document.getElementById('refreshBtn').addEventListener('click', async () => {
            try {
                const alert = await loadCurrentAlert();
                if (alert !== null) {
                    populateForm(alert);
                }
            } catch (err) {
                showStatus('Error refreshing: ' + err.message, true);
            }
        });

        // Admin Key Management
        const keyModal = document.getElementById('keyModal');
        const changeKeyBtn = document.getElementById('changeKeyBtn');
        const cancelKeyBtn = document.getElementById('cancelKeyBtn');
        const saveKeyBtn = document.getElementById('saveKeyBtn');
        const newKeyInput = document.getElementById('newKey');
        const confirmKeyInput = document.getElementById('confirmKey');
        const keyStatus = document.getElementById('keyStatus');

        function showKeyStatus(message, isError = false) {
            keyStatus.textContent = message;
            keyStatus.className = 'status ' + (isError ? 'error' : 'success');
            keyStatus.style.display = 'block';
            setTimeout(() => { keyStatus.style.display = 'none'; }, 5000);
        }

        changeKeyBtn.addEventListener('click', () => {
            keyModal.style.display = 'flex';
            newKeyInput.value = '';
            confirmKeyInput.value = '';
            keyStatus.style.display = 'none';
        });

        cancelKeyBtn.addEventListener('click', () => {
            keyModal.style.display = 'none';
            newKeyInput.value = '';
            confirmKeyInput.value = '';
            keyStatus.style.display = 'none';
        });

        saveKeyBtn.addEventListener('click', async () => {
            const newKey = newKeyInput.value.trim();
            const confirmKey = confirmKeyInput.value.trim();

            if (!newKey || newKey.length < 4) {
                showKeyStatus('Admin key must be at least 4 characters', true);
                return;
            }

            if (newKey !== confirmKey) {
                showKeyStatus('Keys do not match', true);
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/admin/key`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ new_key: newKey })
                });

                if (res.ok) {
                    showKeyStatus('Admin key updated successfully! Re-authenticating...', false);
                    // Update the key and re-authenticate
                    ADMIN_KEY = newKey;
                    headers['X-Admin-Key'] = ADMIN_KEY;
                    sessionStorage.setItem('admin_key', ADMIN_KEY);
                    keyModal.style.display = 'none';
                    showKeyStatus('', false);
                } else if (res.status === 401) {
                    handleAuthError();
                    keyModal.style.display = 'none';
                } else {
                    const err = await res.json();
                    showKeyStatus('Error: ' + (err.error || 'Failed to update admin key'), true);
                }
            } catch (err) {
                showKeyStatus('Error: ' + err.message, true);
            }
        });

        // Close modal on outside click
        keyModal.addEventListener('click', (e) => {
            if (e.target === keyModal) {
                cancelKeyBtn.click();
            }
        });

        // Initial load
        (async () => {
            const alert = await loadCurrentAlert();
            populateForm(alert);
        })();
    </script>
</body>
</html>


